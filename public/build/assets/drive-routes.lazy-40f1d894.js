import{h as V,i as z,k as U,l as W,m as C,n as J,D as L,o as R,p as X,q as S,t as M,v as E,w as P,x as Y,y as Z,z as ee,A as se,j as e,M as ae,B as y,I as F,K as te,C as re,E as D,G as I,T as m,r as g,H as ne,J as T,L as B,N as oe,O as ie,P as A,S as _,Q as le,V as de,W as ce,X as $,Y as ue,Z as he,_ as me,$ as j,a0 as N,a1 as q,a2 as xe,a3 as fe,a4 as pe,a5 as ve,a6 as ge,a7 as we,a8 as je,a9 as be,aa as Pe,ab as ye,ac as Ie,ad as Ne,ae as Se,af as Fe,ag as ke,ah as De,ai as Ce,aj as Le,ak as Me,al as Ee}from"./main-ee4626fc.js";import{am as rs}from"./main-ee4626fc.js";import{I as Te,G as Be}from"./GridView-69083ebb.js";const h=V()(z(s=>({password:null,viewMode:U("drive.viewMode"),activeSort:{orderBy:"updated_at",orderDir:"desc"},setPassword:a=>{s(t=>{t.password=a})},isPasswordProtected:!1,setIsPasswordProtected:a=>{s(t=>{t.isPasswordProtected=a})},setViewMode:a=>{s(t=>{t.viewMode=a,W("drive.viewMode",a)})},setActiveSort:a=>{s(t=>{t.activeSort=a})}})));function v(){return h.getState()}function f(){var i,c;const{hash:s}=C(),{orderBy:a,orderDir:t}=h(l=>l.activeSort),n=`${a}:${t}`,r=h(l=>l.isPasswordProtected),o=h(l=>l.password),d=J({queryKey:L.fetchShareableLink({hash:s,sort:n}),queryFn:async({pageParam:l=1})=>{const u=await Ae({hash:s,page:l,order:n,password:o});return u.passwordInvalid&&v().setIsPasswordProtected(!0),u},initialData:()=>{var u,p;const l=(u=R().loaders)==null?void 0:u.shareableLinkPage;if(l&&((p=l.link)==null?void 0:p.hash)===s)return l.passwordInvalid&&v().setIsPasswordProtected(!0),{pageParams:[void 0,1],pages:[l]}},initialPageParam:1,getNextPageParam:l=>{if(!l.folderChildren)return;const u=l.folderChildren.current_page,p=l.folderChildren.last_page;if(!(u>=p))return u+1},enabled:!!s&&!r||o!=null,placeholderData:X});return{...d,link:(i=d.data)==null?void 0:i.pages[0].link,entries:(c=d.data)==null?void 0:c.pages.flatMap(l=>{var u;return(u=l.folderChildren)==null?void 0:u.data})}}function Ae({hash:s,page:a=1,order:t,password:n}){return S.get(`shareable-links/${s}`,{params:{loader:"shareableLinkPage",page:a,order:t,password:n}}).then(r=>r.data)}function _e({password:s,linkHash:a}){return S.post(`shareable-links/${a}/check-password`,{password:s}).then(t=>t.data)}function $e(){return M({mutationFn:s=>_e(s),onSuccess:(s,a)=>{s.matches&&v().setPassword(a.password)},onError:s=>E(s,P("Could not create link"))})}function qe({linkId:s,password:a}){return S.post(`shareable-links/${s}/import`,{password:a}).then(t=>t.data)}function He(){const s=h(a=>a.password);return M({mutationFn:a=>qe({...a,password:s}),onSuccess:async()=>{await Y.invalidateQueries({queryKey:L.fetchShareableLink()}),Z(P("Item imported into your drive"))},onError:a=>E(a,P("Could not create link"))})}function H(){var d;const{link:s}=f(),{user:a,isLoggedIn:t}=ee(),{downloadUrl:n}=se(s==null?void 0:s.entry),r=He(),o=(d=s==null?void 0:s.entry)==null?void 0:d.users.find(i=>i.id===(a==null?void 0:a.id));return s!=null&&s.entry?e.jsxs("div",{children:[s.allow_download&&e.jsx(Ke,{downloadUrl:n}),!o&&t&&s.allow_edit&&e.jsxs(ae,{onItemSelected:i=>{i==="import"?r.mutate({linkId:s.id}):i==="download"&&n&&y(n)},children:[e.jsx(F,{className:"ml-6",disabled:r.isPending,children:e.jsx(te,{})}),e.jsxs(re,{children:[e.jsx(D,{value:"download",startIcon:e.jsx(I,{}),children:e.jsx(m,{message:"Download"})}),e.jsx(D,{value:"import",startIcon:e.jsx(Te,{}),children:e.jsx(m,{message:"Save a copy to your own drive"})})]})]})]}):null}function Ke({downloadUrl:s}){return e.jsxs(g.Fragment,{children:[e.jsx(ne,{label:e.jsx(m,{message:"Download"}),children:e.jsx(F,{className:"md:hidden",onClick:()=>{s&&y(s)},children:e.jsx(I,{})})}),e.jsx(T,{className:"max-md:hidden",size:"sm",variant:"flat",color:"chip",startIcon:e.jsx(I,{}),onClick:()=>{s&&y(s)},children:e.jsx(m,{message:"Download"})})]})}function K(){const{link:s}=f(),a=B();return e.jsx(oe,{size:"md",color:"bg",className:"flex-shrink-0",rightChildren:(s==null?void 0:s.entry)&&e.jsx(H,{}),menuPosition:"shareable-link-page",hideLogo:a,children:(s==null?void 0:s.entry)&&s.entry.type!=="folder"&&e.jsxs("div",{className:"fex-auto flex min-w-0 items-center gap-10",children:[e.jsx(ie,{className:"flex-shrink-0",type:s.entry.type}),e.jsx("div",{className:"flex-auto overflow-hidden overflow-ellipsis whitespace-nowrap font-medium",children:s.entry.name})]})})}function Oe(){const{trans:s}=A(),{hash:a}=C(),t=s({message:"Password"}),[n,r]=g.useState(""),o=$e(),d=a?a.split(":")[0]:null,i=o.data&&!o.data.matches;return e.jsxs("div",{className:"flex h-screen flex-col bg-alt",children:[e.jsx(K,{}),e.jsx("div",{className:"mx-auto my-80 px-10 md:px-20",children:e.jsxs("div",{className:"flex max-w-[560px] flex-col items-center gap-40 rounded border bg p-24 md:flex-row md:gap-14",children:[e.jsx("div",{className:"h-132 w-[165px]",children:e.jsx(_,{src:le})}),e.jsxs("form",{onSubmit:c=>{c.preventDefault(),o.mutate({linkHash:d,password:n})},children:[e.jsx("span",{className:"text-sm",children:e.jsx(m,{message:"The link you are trying to access is password protected."})}),e.jsx(de,{autoFocus:!0,placeholder:t,"aria-label":t,className:"mb-20 mt-10",type:"password",value:n,required:!0,errorMessage:i&&e.jsx(m,{message:"Password is not valid"}),onChange:c=>{r(c.target.value)}}),e.jsx("div",{className:"text-right",children:e.jsx(T,{variant:"flat",color:"primary",type:"submit",className:"w-full md:w-auto",disabled:o.isPending,children:e.jsx(m,{message:"Enter"})})})]})]})})]})}function Ge({entries:s,onEntrySelected:a}){return e.jsx("div",{className:"file-grid",children:s.map((t,n)=>e.jsx(ce,{tabIndex:-1,className:"hover:shadow-md cursor-pointer bg",entry:t,onContextMenu:r=>{r.preventDefault()},onKeyDown:r=>{(r.key==="Enter"||r.key===" ")&&a(t,n)},onClick:()=>{a(t,n)}},t.id))})}const Qe=$.filter(s=>s.key!=="updated_at");function Ve({entries:s,onEntrySelected:a}){const t=h(r=>r.activeSort),n=B();return e.jsx(ue,{columns:n?Qe:$,data:s,sortDescriptor:t,onSortChange:r=>{v().setActiveSort(r)},onAction:(r,o)=>{a(r,o)},enableSelection:!1})}function ze(s,a){var n;let t=s.hash;return a&&((n=s.entry)==null?void 0:n.hash)!==a&&(t=`${t}:${a}`),t}function O(){const{link:s}=f(),a=he();return t=>{s&&a(`/drive/s/${ze(s,t)}`)}}function Ue({className:s}){const{pathname:a}=me(),t=O(),[n,r]=g.useState(),o=h(x=>x.viewMode),d=g.useRef(null),{link:i,entries:c,isFetchingNextPage:l,hasNextPage:u,fetchNextPage:p,isPlaceholderData:G}=f();if(g.useEffect(()=>{r(void 0)},[a]),g.useEffect(()=>{const x=d.current;if(!x)return;const w=new IntersectionObserver(([Q])=>{Q.isIntersecting&&u&&p()});return w.observe(x),()=>{w.unobserve(x)}},[u,p]),!i||G)return e.jsx("div",{className:j("flex justify-center",s),children:e.jsx(N,{isIndeterminate:!0})});const k=(x,w)=>{x.type==="folder"?t(x.hash):r(w)},b=c||[];return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:j("file-grid-container flex-auto overflow-auto px-14 pb-14 md:px-24 md:pb-24",s),children:[e.jsx(q,{slot:"file-preview",className:"mb-40"}),o==="grid"?e.jsx(Ge,{entries:b,onEntrySelected:k}):e.jsx(Ve,{entries:b,onEntrySelected:k}),e.jsx("span",{ref:d,"aria-hidden":!0}),e.jsx(xe,{children:l&&e.jsx(fe.div,{className:"mt-24 flex w-full justify-center",...pe,children:e.jsx(N,{isIndeterminate:!0,"aria-label":"loading"})})})]}),e.jsx(ve,{type:"modal",isOpen:n!=null,onClose:()=>r(void 0),children:e.jsx(ge,{entries:b,defaultActiveIndex:n,allowDownload:i.allow_download})})]})}function We({className:s,folder:a,link:t}){const n=O(),r=h(i=>i.password),o=we({hash:a==null?void 0:a.hash,params:{shareable_link:t.id,password:r}});let d;if(o.isLoading)d=null;else{const i=[];o.data&&o.data.path.forEach(c=>{i.push({folder:c,label:e.jsx(e.Fragment,{children:c.name})})}),d=e.jsx(je,{size:"lg",isNavigation:!0,children:i.map(c=>e.jsx(be,{onSelected:()=>{n(c.folder.hash)},children:c.label},c.folder.hash))})}return e.jsx("div",{className:j("h-36 flex-shrink-0",s),children:d})}function Je(){const s=h(r=>r.activeSort),{link:a,isFetching:t}=f(),n=a&&a.entry;return e.jsxs("div",{className:"flex flex-col justify-between gap-14 p-14 md:h-90 md:flex-row md:items-center md:p-24",children:[n&&e.jsx(We,{link:a,folder:a.entry,className:"flex-auto"}),n&&e.jsxs("div",{className:"flex items-center justify-between text-muted md:justify-start",children:[e.jsx(Pe,{isDisabled:t,descriptor:s,onChange:r=>{v().setActiveSort(r)}}),e.jsx("div",{className:"ml-10 md:border-l md:pl-10",children:e.jsx(F,{onClick:()=>{v().setViewMode(v().viewMode==="grid"?"list":"grid")},children:e.jsx(Be,{})})})]})]})}function Re(){const{entries:s,isFetched:a}=f(),t=a&&!(s!=null&&s.length);return e.jsxs(ye,{name:"folder-preview",children:[e.jsx(Ie,{hideToggleButton:!0,rightChildren:e.jsx(H,{}),color:"bg"}),e.jsx(Ne,{children:e.jsx(Je,{})}),e.jsx(Se,{children:e.jsx(Fe,{children:t?e.jsx(Xe,{}):e.jsx(Ue,{})})})]})}function Xe({className:s}){return e.jsx(ke,{className:j(s,"mt-80"),image:e.jsx(_,{src:De}),title:e.jsx(m,{message:"Folder is empty"}),description:e.jsx(m,{message:"No files have been uploaded to this folder yet"})})}function Ye(){const{link:s}=f();return s!=null&&s.entry?e.jsxs("div",{className:"flex h-screen flex-col bg-alt",children:[e.jsx(K,{}),e.jsx(q,{slot:"file-preview",className:"mx-auto mt-24"}),e.jsx(Ce,{entries:[s.entry],showHeader:!1,allowDownload:s.allow_download})]}):null}function ss(){var d;const{status:s,link:a}=f(),{trans:t}=A(),n=h(i=>i.isPasswordProtected),r=h(i=>i.password);let o;if(s==="pending")o=e.jsx("div",{className:"flex h-screen flex-auto items-center justify-center",children:e.jsx(N,{"aria-label":t({message:"Loading link"}),isIndeterminate:!0})});else{if(!a&&!n)return e.jsx(Le,{});n&&!r?o=e.jsx(Oe,{}):((d=a==null?void 0:a.entry)==null?void 0:d.type)==="folder"?o=e.jsx(Re,{}):o=e.jsx(Ye,{})}return e.jsx(Me,{children:e.jsx(Ee.Provider,{value:{shareable_link:a==null?void 0:a.id,password:r},children:o})})}export{rs as DriveLayout,ss as ShareableLinkPage};
//# sourceMappingURL=drive-routes.lazy-40f1d894.js.map
